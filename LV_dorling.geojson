---
title: "R Notebook"
output: html_notebook
---



```{r}
library( dplyr )
library( tidycensus )
library( sp )

# load your census API key:
# census_api_key("98690b302968e944154798c63628d22a1b9c851d")
# key <- "abc123"
# census_api_key( key )

LV.pop1 <-
get_acs( geography = "tract", variables = "B01003_001",
         state = "04", county = county.fips[state.fips=="04"], geometry = TRUE ) %>% 
         select( GEOID, estimate ) %>%
         rename( POP=estimate )

LV.pop2 <-
get_acs( geography = "tract", variables = "B01003_001",
         state = "32", county = county.fips[state.fips=="32"], geometry = TRUE ) %>% 
         select( GEOID, estimate ) %>%
         rename( POP=estimate )

LV.pop <- rbind( LV.pop1, LV.pop2 )


# get a census tract shapefile
# and add census data: 

library( tigris )
library( pander )

LV <- tracts( state="32", county= "003", cb=TRUE, year=2015 )

```

```{r}

LV.pop <-
get_acs( geography = "tract", variables = "B01003_001",
         state = "32", county = "003", geometry = FALSE ) %>% 
         select( GEOID, estimate ) %>%
         rename( POP=estimate )

LV.mhhi <- 
  get_acs( geography = "tract", variables = "B19013_001",
           state = "32", county = "003", geometry = FALSE ) %>% 
  select( GEOID, estimate ) %>% 
  rename( MHHI=estimate )


# get a census tract shapefile
# and add census data: 

library( tigris )
library( pander )

phx <- tracts( state="32", county="003", cb=TRUE, year=2015 )
```
```{r}

LV <- merge( LV, LV.pop, by.x="GEOID", by.y="GEOID" )
LV <- merge( LV, LV.mhhi, by.x="GEOID", by.y="GEOID" )

# convert sf map object to an sp version
LV.sp <- as_Spatial( LV )

class( LV.sp )

## [1] "SpatialPolygonsDataFrame"
## attr(,"package")
## [1] "sp"

plot( LV.sp )

```

```{r}

library( cartogram )  # spatial maps w/ tract size bias reduction
library( maptools )   # spatial object manipulation 
library( sf )         # 'simple features' flavor of shapefiles

# project map and remove empty tracts
LV.sp <- spTransform( LV.sp, CRS("+init=epsg:3395"))
LV.sp <- LV.sp[ LV.sp$POP != 0 & (! is.na( LV.sp$POP )) , ]

# convert census tract polygons to dorling cartogram
# no idea why k=0.03 works, but it does - default is k=5
LV.sp$pop.w <- LV.sp$POP / 9000 # max(LV.sp$POP)   # standardizes it to max of 1.5
LV_dorling <- cartogram_dorling( x=LV.sp, weight="pop.w", k=0.05 )
plot( LV_dorling )
```



```{r}
# install.packages( "tmap" )
library( tmap )       # thematic maps

tm_shape( LV_dorling ) + 
  tm_polygons( size="POP", col="MHHI", n=7, style="quantile", palette="Spectral" ) 

```


```{r}
# WRITE TO FILE 

library( geojsonio )

LV_dorling <- spTransform( LV_dorling, CRS("+proj=longlat +datum=WGS84") )
geojson_write( LV_dorling, file="LV_dorling.geojson", geometry="polygon" )

```










